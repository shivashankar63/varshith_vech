<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Driver Dashboard ‚Äì Smart Bus Tracking</title>
  <link rel="stylesheet" href="../assets/styles.css" />
  <link rel="icon" href="../assets/icon.png" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    .status-indicator.active {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }
    .status-indicator.inactive {
      background: rgba(148, 163, 184, 0.15);
      color: var(--muted);
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }
    .status-indicator.active .status-dot {
      background: #22c55e;
    }
    .status-indicator.inactive .status-dot {
      background: var(--muted);
      animation: none;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(1.2); }
    }
    .info-grid {
      display: grid;
      gap: 12px;
      margin-top: 12px;
    }
    .info-item {
      display: flex;
      justify-content: space-between;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      transition: background 0.2s ease;
    }
    .info-item:hover {
      background: rgba(255, 255, 255, 0.08);
    }
    .info-label {
      color: var(--muted);
      font-size: 14px;
    }
    .info-value {
      font-weight: 600;
      color: var(--text);
    }
    .action-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .skeleton {
      background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 4px;
      height: 20px;
    }
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
  </style>
</head>
<body class="app dark">
  <header class="app-header" role="banner">
    <div class="brand">
      <img src="../assets/images/bus.svg" alt="Bus icon" class="brand-icon" />
      <h1>Driver Dashboard</h1>
    </div>
    <div class="header-actions">
      <span id="driverName" style="margin-right:12px;color:var(--muted)" aria-label="Driver name">Driver</span>
      <button id="btnLogout" class="btn" aria-label="Logout from dashboard" title="Logout">Logout</button>
    </div>
  </header>

  <main class="layout" role="main" style="grid-template-columns:1fr">
    <div style="padding:20px;max-width:1200px;margin:0 auto">
      <section class="card" aria-labelledby="assignment-heading">
        <h2 id="assignment-heading">Your Bus Assignment</h2>
        <div id="assignmentInfo" class="info-grid">
          <div class="info-item">
            <span class="info-label">Bus ID</span>
            <span id="busId" class="info-value">‚Äì</span>
          </div>
          <div class="info-item">
            <span class="info-label">Route</span>
            <span id="routeInfo" class="info-value">‚Äì</span>
          </div>
          <div class="info-item">
            <span class="info-label">Contact</span>
            <span id="driverPhone" class="info-value">‚Äì</span>
          </div>
        </div>
      </section>

      <section class="card" aria-labelledby="location-heading">
        <h2 id="location-heading">Location Sharing</h2>
        <div style="margin-bottom:16px;display:flex;gap:12px;flex-wrap:wrap">
          <button id="btnStartSharing" class="btn" style="background:var(--accent-2)" 
                  aria-label="Start sharing your location" title="Start GPS tracking">
            <span>‚ñ∂</span> Start Sharing
          </button>
          <button id="btnStopSharing" class="btn btn-danger" disabled 
                  aria-label="Stop sharing your location" title="Stop GPS tracking">
            <span>‚èπ</span> Stop Sharing
          </button>
        </div>
        <div id="sharingStatus" class="status-indicator inactive" role="status" aria-live="polite">
          <span class="status-dot"></span>
          <span>Not sharing</span>
        </div>
      </section>

      <section class="card" aria-labelledby="actions-heading">
        <h2 id="actions-heading">Quick Actions</h2>
        <div class="action-grid">
          <button id="btnEmergency" class="btn btn-danger" 
                  aria-label="Report emergency situation" title="Send emergency alert">
            üö® Emergency
          </button>
          <button id="btnViewRoute" class="btn" 
                  aria-label="Refresh route map view" title="Recenter map">
            üó∫Ô∏è View Route
          </button>
          <button id="btnRefreshData" class="btn" 
                  aria-label="Refresh assignment data" title="Reload bus info">
            üîÑ Refresh
          </button>
        </div>
      </section>

      <section class="card" aria-labelledby="map-heading">
        <h2 id="map-heading">Your Route Map</h2>
        <div id="driverMap" style="height:450px;border-radius:12px;overflow:hidden" 
             role="region" aria-label="Interactive route map"></div>
      </section>
    </div>
  </main>

  <!-- Emergency Modal -->
  <dialog id="emergencyModal" class="modal" aria-labelledby="emergency-modal-title">
    <form method="dialog" class="modal-card" id="emergencyForm">
      <header>
        <h3 id="emergency-modal-title">Report Emergency</h3>
      </header>
      <div class="modal-body">
        <div class="field">
          <label for="emType">Emergency Type</label>
          <select id="emType" required aria-label="Select emergency type" title="Choose emergency category">
            <option value="">Select type...</option>
            <option value="breakdown">üîß Vehicle Breakdown</option>
            <option value="accident">üí• Accident</option>
            <option value="medical">üè• Medical Emergency</option>
            <option value="traffic">üö¶ Severe Traffic Jam</option>
            <option value="other">‚ö†Ô∏è Other Issue</option>
          </select>
        </div>
        <div class="field">
          <label for="emNotes">Details</label>
          <textarea id="emNotes" rows="4" 
                    placeholder="Please describe the situation in detail..." 
                    aria-label="Emergency details and description"
                    title="Provide emergency details"></textarea>
        </div>
      </div>
      <footer class="modal-actions">
        <button type="submit" class="btn btn-danger" aria-label="Send emergency alert">Send Alert</button>
        <button type="button" class="btn btn-ghost" id="btnCloseModal" aria-label="Cancel and close modal">Cancel</button>
      </footer>
    </form>
  </dialog>

  <div id="toast" class="toast" role="alert" aria-live="polite"></div>

  <script src="../assets/ui.js"></script>
  <script src="../assets/auth.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    window.SUPABASE_URL = "https://xeibdoqrxpqgdwuackfc.supabase.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhlaWJkb3FyeHBxZ2R3dWFja2ZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNzYyNTAsImV4cCI6MjA3OTc1MjI1MH0.J3b3xaAa532E03mUYHjFabBhd7kwNvoLkoSQJ0CX04k";
  </script>
  <script src="../assets/supabaseClient.js"></script>
  <script>
    // Driver dashboard logic
    let map, busMarker, routePolyline;
    let sharingInterval = null;
    let updateCount = 0;

    function toast(msg, type = 'info'){
      if(window.UI && UI.toast){
        UI.toast(msg, type);
      } else {
        const el = document.getElementById('toast');
        el.textContent = msg;
        el.className = `toast ${type}`;
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 3000);
      }
    }

    async function init(){
      // Check auth
      const session = Auth.getSession();
      if(!session || session.role !== 'driver'){
        toast('Please login as a driver', 'error');
        setTimeout(() => location.href = '../auth/login-driver.html', 1500);
        return;
      }

      // Display driver info
      document.getElementById('driverName').textContent = session.fullName || 'Driver';
      document.getElementById('driverName').setAttribute('aria-label', `Logged in as ${session.fullName || 'Driver'}`);
      
      // Show loading state
      showLoadingState();
      
      await loadDriverData(session);

      // Buttons
      document.getElementById('btnStartSharing').onclick = startSharing;
      document.getElementById('btnStopSharing').onclick = stopSharing;
      document.getElementById('btnEmergency').onclick = () => document.getElementById('emergencyModal').showModal();
      document.getElementById('btnCloseModal').onclick = () => document.getElementById('emergencyModal').close();
      document.getElementById('emergencyForm').onsubmit = sendEmergency;
      document.getElementById('btnLogout').onclick = handleLogout;
      document.getElementById('btnViewRoute').onclick = refreshMapView;
      document.getElementById('btnRefreshData').onclick = () => loadDriverData(session);
    }

    function showLoadingState(){
      document.getElementById('busId').innerHTML = '<div class="skeleton" style="width:80px"></div>';
      document.getElementById('routeInfo').innerHTML = '<div class="skeleton" style="width:120px"></div>';
      document.getElementById('driverPhone').innerHTML = '<div class="skeleton" style="width:100px"></div>';
    }

    async function loadDriverData(session){
      const busIdEl = document.getElementById('busId');
      const routeEl = document.getElementById('routeInfo');
      const phoneEl = document.getElementById('driverPhone');

      busIdEl.textContent = session.busId || '‚Äì';
      phoneEl.textContent = session.phone || '‚Äì';
      routeEl.textContent = 'Loading...';

      // Load route info
      if(window.SB && typeof SB.getRoutesWithDetails === 'function'){
        try{
          const routes = await SB.getRoutesWithDetails();
          const route = routes.find(r => r.buses?.some(b => b.id === session.busId));
          if(route){
            routeEl.textContent = route.name || route.code || 'N/A';
            routeEl.setAttribute('title', `Route: ${route.name || route.code}`);
            renderMap(route);
            toast('Route loaded successfully', 'success');
          } else {
            routeEl.textContent = 'Not assigned';
            toast('No route assigned to your bus', 'info');
          }
        } catch(e){
          console.error('Failed to load route', e);
          routeEl.textContent = 'Error loading';
          toast('Failed to load route information', 'error');
        }
      }
    }

    function handleLogout(){
      if(sharingInterval){
        stopSharing();
      }
      Auth.clear();
      toast('Logging out...', 'info');
      setTimeout(() => location.href = '../index.html', 1000);
    }

    function refreshMapView(){
      if(map){
        map.invalidateSize();
        if(routePolyline){
          map.fitBounds(routePolyline.getBounds(), { padding: [20,20] });
        }
        toast('Map view refreshed', 'success');
      } else {
        toast('Map not loaded yet', 'error');
      }
    }

    function renderMap(route){
      if(!map){
        map = L.map('driverMap').setView([17.385, 78.4867], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
      }
      
      if(route.stops && route.stops.length > 0){
        const path = route.stops.map(s => [s.lat, s.lng]);
        if(routePolyline) map.removeLayer(routePolyline);
        routePolyline = L.polyline(path, { color: '#22c55e', weight: 4 }).addTo(map);
        map.fitBounds(routePolyline.getBounds(), { padding: [20,20] });
        
        // Add markers for stops
        route.stops.forEach(s => {
          L.marker([s.lat, s.lng]).bindPopup(s.name).addTo(map);
        });
      }
    }

    function startSharing(){
      if(!navigator.geolocation){
        return toast('Geolocation not supported by your device', 'error');
      }

      const startBtn = document.getElementById('btnStartSharing');
      const stopBtn = document.getElementById('btnStopSharing');
      const statusEl = document.getElementById('sharingStatus');

      startBtn.disabled = true;
      stopBtn.disabled = false;
      statusEl.className = 'status-indicator active';
      statusEl.innerHTML = '<span class="status-dot"></span><span>Sharing location</span>';

      updateCount = 0;

      sharingInterval = setInterval(async () => {
        navigator.geolocation.getCurrentPosition(async (pos) => {
          const { latitude, longitude } = pos.coords;
          const speed = pos.coords.speed ? (pos.coords.speed * 3.6).toFixed(1) : 0;
          
          updateCount++;
          
          // Update marker on map
          if(!busMarker && map){
            const busIcon = L.divIcon({
              className: 'bus-marker-active',
              html: 'üöå',
              iconSize: [32, 32]
            });
            busMarker = L.marker([latitude, longitude], { icon: busIcon })
              .addTo(map)
              .bindPopup(`Your location<br>Speed: ${speed} km/h`);
            map.setView([latitude, longitude], 15);
          } else if(busMarker){
            busMarker.setLatLng([latitude, longitude]);
            busMarker.getPopup().setContent(`Your location<br>Speed: ${speed} km/h<br>Updates: ${updateCount}`);
          }

          // Send to Supabase if available
          if(window.SB && typeof SB.bulkUpsertPositions === 'function'){
            try{
              const session = Auth.getSession();
              await SB.bulkUpsertPositions([{
                bus_id: session.busId,
                lat: latitude,
                lng: longitude,
                speed: parseFloat(speed),
                created_at: new Date().toISOString()
              }]);
            } catch(e){
              console.warn('Failed to send position', e);
            }
          }
        }, (err) => {
          console.error('Geolocation error', err);
          toast('GPS error: ' + err.message, 'error');
        });
      }, 5000); // Update every 5 seconds

      toast('Location sharing started', 'success');
    }

    function stopSharing(){
      if(sharingInterval){
        clearInterval(sharingInterval);
        sharingInterval = null;
      }
      
      const startBtn = document.getElementById('btnStartSharing');
      const stopBtn = document.getElementById('btnStopSharing');
      const statusEl = document.getElementById('sharingStatus');

      startBtn.disabled = false;
      stopBtn.disabled = true;
      statusEl.className = 'status-indicator inactive';
      statusEl.innerHTML = '<span class="status-dot"></span><span>Not sharing</span>';
      
      toast(`Location sharing stopped (sent ${updateCount} updates)`, 'info');
      updateCount = 0;
    }

    async function sendEmergency(e){
      e.preventDefault();
      
      const type = document.getElementById('emType').value;
      const notes = document.getElementById('emNotes').value;

      if(!type){
        toast('Please select an emergency type', 'error');
        return;
      }
      
      const submitBtn = e.submitter;
      const originalText = submitBtn.textContent;
      
      if(window.UI && UI.withLoading){
        await UI.withLoading(submitBtn, async () => {
          await sendEmergencyAlert(type, notes);
        });
      } else {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Sending...';
        await sendEmergencyAlert(type, notes);
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
      
      document.getElementById('emergencyModal').close();
      document.getElementById('emergencyForm').reset();
    }

    async function sendEmergencyAlert(type, notes){
      try{
        const session = Auth.getSession();
        if(window.SB && typeof SB.createAlert === 'function'){
          await SB.createAlert({ busId: session.busId, type, notes });
          toast('üö® Emergency alert sent successfully!', 'success');
        } else {
          console.log('EMERGENCY', { busId: session.busId, type, notes });
          toast('Emergency logged (demo mode)', 'info');
        }
      } catch(err){
        console.error('Alert failed', err);
        toast('Failed to send emergency alert', 'error');
        throw err;
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
