<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>User Dashboard ‚Ä¢ Smart Bus</title>
  <link rel="stylesheet" href="../assets/styles.css">
  <style>
    .wrap{display:grid;grid-template-columns:360px 1fr;gap:12px;padding:12px;height:calc(100vh - 60px)}
          <button class="btn" id="btnStarRoute" title="Favorite route" style="margin-top:8px">‚≠ê Favorite</button>
          <div id="favRoutes" style="margin-top:8px;font-size:12px;color:var(--muted)">No favorites yet</div>
    header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border)}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;overflow:auto}
    .map{height:450px;min-height:360px;border-radius:12px;overflow:hidden}
    .route-card{background:#0b1220;border:1px solid var(--border);border-radius:8px;padding:12px;margin:8px 0;cursor:pointer;transition:all .2s}
    .route-card:hover{border-color:#3b82f6;background:#0f1520}
    .route-card.active{border-color:#22c55e;background:#0f1820}
    .bus-card{background:#0b1220;border:1px solid var(--border);border-radius:8px;padding:10px;margin:6px 0}
    .eta-badge{display:inline-block;padding:4px 8px;background:#22c55e;color:white;border-radius:6px;font-size:12px;font-weight:600}
    .section-title{font-size:13px;color:var(--muted);margin:12px 0 6px;font-weight:600;text-transform:uppercase}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
          <button class="btn" id="btnShare">Share ETA</button>
          <button class="btn" id="btnNotify">Enable Push</button>
  <script src="../assets/errorHandler.js"></script>
  <script src="../assets/performance.js"></script>
  <script src="../assets/config.js"></script>
  <script src="../assets/supabaseClient.js"></script>
  
</head>
        <div id="qrWrap" style="margin-top:10px;display:none">
          <strong>üéüÔ∏è Boarding Pass</strong>
          <canvas id="qrCanvas" width="160" height="160" style="margin-top:6px;border:1px solid var(--border);border-radius:6px"></canvas>
        </div>
<body>
  <header>
    <strong>User Dashboard</strong>
    <nav style="display:flex;gap:8px">
      <a class="btn" href="../tracker.html">Live Map</a>
      <a class="btn" href="../index.html">Home</a>
      <button class="btn" id="btnLogout">Logout</button>
        <div id="crowdingIndicator" style="font-size:13px;color:var(--muted)">Crowding indicator appears here.</div>
  </header>

  <div class="wrap">
    <aside class="panel">
      <h3 style="margin-top:0;font-size:16px">üëã Welcome, <span id="userName"></span></h3>
      <div id="userInfo" style="font-size:12px;color:var(--muted);margin-bottom:12px"></div>

      <div class="section-title">üìç Track Bus by Route</div>
      <div id="routesList"></div>

      <div class="section-title">üöç Select Bus</div>
      <div id="busesList"></div>

      <div class="section-title">‚è±Ô∏è Live Arrivals</div>
      <div id="arrivalBoard" style="font-size:12px;color:var(--muted)">Select a route to see arrivals</div>

      <div class="section-title">üó∫Ô∏è Journey Planner</div>
      <div class="card" style="margin-top:6px">
        <div class="field" style="margin-bottom:8px">
          <label style="font-size:12px;color:var(--muted)">From</label>
          <select id="fromStop" style="width:100%;padding:8px;background:#0b1220;border:1px solid var(--border);border-radius:6px;color:var(--text)">
            <option value="">Select starting point</option>
          </select>
        </div>
        <div class="field">
          <label style="font-size:12px;color:var(--muted)">To</label>
          <select id="toStop" style="width:100%;padding:8px;background:#0b1220;border:1px solid var(--border);border-radius:6px;color:var(--text)">
            <option value="">Select destination</option>
          </select>
        </div>
        <button class="btn btn-primary" id="btnPlanJourney" style="width:100%;margin-top:8px">Get Route & ETA</button>
      </div>

      <div id="journeyResult" style="display:none;margin-top:12px"></div>

      <div class="section-title">üîî Notifications</div>
      <div class="card" style="margin-top:6px;font-size:13px">
        <label class="toggle" style="margin-bottom:6px">
          <input type="checkbox" id="notifyDelay" checked />
          <span>Bus Delay Alerts</span>
        </label>
        <label class="toggle" style="margin-bottom:6px">
          <input type="checkbox" id="notifyEmergency" checked />
          <span>Emergency Alerts</span>
        </label>
        <label class="toggle">
          <input type="checkbox" id="notifyETA" />
          <span>ETA Updates (10 min before)</span>
        </label>
      </div>
    </aside>
    
    <main class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h3 style="margin:0;font-size:16px">üß∞ User Tools</h3>
        <div style="display:flex;gap:8px">
          <button class="btn" id="btnRefresh">üîÑ Refresh</button>
          <button class="btn" id="btnLocateMe">üìç My Location</button>
          <button class="btn btn-primary" id="btnOpenMap">üó∫Ô∏è Open Live Map</button>
        </div>
      </div>
      <div class="main-grid" style="display:grid;grid-template-columns:1fr;gap:12px">
        <div>
          <div class="section-title">üöç Selected Bus</div>
          <div id="selectedBusInfo" class="card" style="display:none;padding:12px">
            <h4 style="margin:0 0 8px;font-size:14px" id="infoBusName"></h4>
            <div style="font-size:12px">
              <div style="margin:4px 0"><strong>Route:</strong> <span id="infoRoute"></span></div>
              <div style="margin:4px 0"><strong>Speed:</strong> <span id="infoSpeed"></span> km/h</div>
              <div style="margin:4px 0"><strong>Next Stop:</strong> <span id="infoNextStop"></span></div>
              <div style="margin:4px 0"><strong>ETA:</strong> <span class="eta-badge" id="infoETA"></span></div>
            </div>
          </div>

          <div class="section-title">üß≠ Journey Details</div>
          <div id="journeyResult" class="card" style="display:none;padding:12px"></div>

          <div class="section-title">üìç Your Location</div>
          <div class="card" style="padding:12px">
            <div id="userLocationText" style="font-size:13px;color:var(--muted)">Not determined yet</div>
          </div>

          <div class="section-title">üîî Status</div>
          <div class="card" style="padding:12px">
            <div style="font-size:13px;color:var(--muted)">No active alerts</div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="../assets/auth.js"></script>
  <script>
    const session = Auth.requireRole('user');
    document.getElementById('btnLogout').onclick = () => { Auth.clear(); location.href = '../auth/login-user.html'; };
    document.getElementById('userName').textContent = session.fullName || session.userId;
    document.getElementById('userInfo').textContent = `${session.userType === 'faculty' ? 'Faculty' : 'Student'} ‚Ä¢ ${session.userId} ‚Ä¢ ${session.email}`;

    let routes, selectedRoute = null, selectedBus = null;
    let busSubs = {}; // subscriptions by busId
    let busPositions = {}; // latest positions by busId
    let liveMode = false;

    // Load route data with retry and cache
    (async () => {
      try {
        if(window.SB && typeof SB.getRoutesWithDetails === 'function'){
          routes = await ErrorHandler.withRetry(() => SB.getRoutesWithDetails(), 'getRoutes');
          liveMode = true;
          CacheManager.cacheRoutes(routes);
        } else {
          const cached = CacheManager.getCachedRoutes();
          if(cached){
            routes = cached;
            ErrorHandler.showToast('Using cached routes', 'info');
          } else {
            const res = await fetch('../assets/data/routes.json');
            const data = await res.json();
              const favBtn = document.getElementById('btnStarRoute');
              const favList = document.getElementById('favRoutes');
              const shareBtn = document.getElementById('btnShare');
              const notifyBtn = document.getElementById('btnNotify');
              const qrCanvas = document.getElementById('qrCanvas');
              const qrWrap = document.getElementById('qrWrap');
              const crowdEl = document.getElementById('crowdingIndicator');
            routes = data.routes;
          }
        }
        renderRoutes();
        renderStops();
      } catch (e){ 
                  renderFavorites(routes);
        console.error('Failed to load routes', e);
        ErrorHandler.showToast('Failed to load routes. Check connection.', 'error');
      }
    })();

    function renderRoutes(){
      const list = document.getElementById('routesList');
      list.innerHTML = routes.map(r => `
        <div class="route-card" data-route="${r.id}">
          <strong style="font-size:14px">${r.name}</strong>
          <div style="font-size:12px;color:var(--muted);margin-top:2px">${r.stops.length} stops ‚Ä¢ ${r.buses.length} buses</div>
        </div>
      `).join('');
      
      list.querySelectorAll('.route-card').forEach(card => {
                // Generate QR boarding pass
                const payload = JSON.stringify({ route, bus, stop, ts: Date.now(), etaMin });
                generateQR(qrCanvas, payload); qrWrap.style.display = 'block';
        card.onclick = () => {
          list.querySelectorAll('.route-card').forEach(c => c.classList.remove('active'));
              // Favorites
              favBtn.onclick = () => {
                const rid = routeSel.value; if(!rid) return;
                const list = getFavs(); if(!list.includes(rid)) list.push(rid); setFavs(list);
                renderFavorites();
              };
              function getFavs(){ try { return JSON.parse(localStorage.getItem('favRoutes')||'[]'); } catch { return []; } }
              function setFavs(list){ try { localStorage.setItem('favRoutes', JSON.stringify(list)); } catch {} }
              function renderFavorites(routes){
                const favs = getFavs();
                if(!favs.length){ favList.textContent = 'No favorites yet'; return; }
                favList.innerHTML = 'Favorites: ' + favs.map(id => `<a href="#" data-route="${id}">${id}</a>`).join(', ');
                favList.querySelectorAll('a').forEach(a => a.onclick = (e) => { e.preventDefault(); routeSel.value = a.dataset.route; onRouteChange(routes || []); });
              }

              // Share ETA link
              shareBtn.onclick = () => {
                const params = new URLSearchParams({ route: routeSel.value, bus: busSel.value, stop: stopSel.value });
                const url = `${location.origin}/tracker.html?${params.toString()}`;
                navigator.clipboard.writeText(url).then(() => ErrorHandler.showToast('Link copied!', 'success'));
              };

              // Push notifications
              notifyBtn.onclick = async () => {
                try{
                  const perm = await Notification.requestPermission();
                  if(perm !== 'granted') return ErrorHandler.showToast('Notification permission denied', 'error');
                  // Simple demo notification (prod: push via server)
                  new Notification('Smart Bus', { body: `Your bus (${busSel.value}) is 5 mins away` });
                } catch(e){ ErrorHandler.showToast('Failed to enable push', 'error'); }
              };

              // Crowding indicator from driver logs (occupancy %)
              async function loadCrowding(){
                try {
                  const busId = busSel.value; if(!busId) return;
                  const { data, error } = await SB.client
                    .from('driver_logs')
                    .select('type,value,created_at')
                    .eq('bus_id', busId)
                    .in('type', ['passenger_log'])
                    .order('created_at', { ascending: false })
                    .limit(1);
                  if(error) throw error;
                  const v = (data && data[0]?.value) || 0; // assume bus capacity 60
                  const pct = Math.min(100, Math.round((v/60)*100));
                  const level = pct < 50 ? 'üü¢' : (pct <= 80 ? 'üü°' : 'üî¥');
                  crowdEl.textContent = `${level} Occupancy: ${pct}%`;
                } catch(e){ crowdEl.textContent = 'Crowding data unavailable'; }
              }
              busSel.addEventListener('change', loadCrowding);

              // Minimal QR generator (error correction omitted)
              function generateQR(canvas, text){
                if(!canvas) return;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
                // hash to pseudo pattern
                let h=0; for(let i=0;i<text.length;i++){ h=(h*31 + text.charCodeAt(i))>>>0; }
                const size=20; for(let y=0;y<8;y++){ for(let x=0;x<8;x++){
                  const bit = ((h >> ((x+y)%32)) & 1) ^ ((x*y)%2);
                  ctx.fillStyle = bit ? '#000' : '#fff';
                  ctx.fillRect(10 + x*size, 10 + y*size, size-2, size-2);
                }}
              }

          card.classList.add('active');
          selectedRoute = routes.find(r => r.id === card.dataset.route);
          renderBuses();
          drawRoute();
        };
      });
    }

    function renderBuses(){
      if(!selectedRoute) return;
      const list = document.getElementById('busesList');
      list.innerHTML = (selectedRoute.buses || []).map(b => `
        <div class="bus-card" data-bus="${b.id}">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong style="font-size:13px">üöå ${b.name || b.id}</strong>
            <span class="eta-badge" id="bus-eta-${b.id}">--</span>
          </div>
          <div style="font-size:11px;color:var(--muted);margin-top:4px">Driver: ${b.driver ? b.driver.name : 'unknown'}</div>
        </div>
      `).join('');

      list.querySelectorAll('.bus-card').forEach(card => {
        card.onclick = () => {
          list.querySelectorAll('.bus-card').forEach(c => c.style.borderColor = 'var(--border)');
          card.style.borderColor = '#3b82f6';
          selectedBus = selectedRoute.buses.find(b => b.id === card.dataset.bus);
          showBusOnMap();
        };
      });

      // Subscribe to all buses on route if live mode
      if(liveMode && window.SB){
        // Unsubscribe previous
        Object.values(busSubs).forEach(ch => { try{ ch.unsubscribe(); } catch{} });
        busSubs = {};
        (selectedRoute.buses || []).forEach(b => {
          busSubs[b.id] = SB.subscribeBusPositions(b.id, (payload) => {
            const row = payload && (payload.new || payload.record || payload);
            if(!row) return;
            busPositions[b.id] = { lat: row.lat, lng: row.lng, speed: row.speed, updated: new Date() };
            updateArrivals();
          });
        });
      }
      updateArrivals();
    }

    function renderStops(){
      const fromSel = document.getElementById('fromStop');
      const toSel = document.getElementById('toStop');
      routes.forEach(r => {
        r.stops.forEach(s => {
          fromSel.innerHTML += `<option value="${s.name}">${s.name} (${r.name})</option>`;
          toSel.innerHTML += `<option value="${s.name}">${s.name} (${r.name})</option>`;
        });
      });
    }

    function drawRoute(){
      if(!selectedRoute) return;
      // Route selected; visuals available in Live Map.
    }

    function updateArrivals(){
      if(!selectedRoute) return;
      const board = document.getElementById('arrivalBoard');
      const stops = selectedRoute.stops || [];
      if(stops.length === 0){ board.textContent = 'No stops available'; return; }
      
      // Build arrival table per stop
      let html = '';
      stops.slice(0, 5).forEach(stop => {
        const arrivals = [];
        (selectedRoute.buses || []).forEach(bus => {
          const pos = busPositions[bus.id];
          if(pos){
            const eta = computeETA(pos, stop, selectedRoute);
            arrivals.push({ bus: bus.name || bus.id, eta });
          } else {
            arrivals.push({ bus: bus.name || bus.id, eta: '--' });
          }
        });
        arrivals.sort((a,b) => (typeof a.eta === 'number' ? a.eta : 999) - (typeof b.eta === 'number' ? b.eta : 999));
        html += `<div style="margin:6px 0;padding:6px;background:#0b1220;border-radius:6px">
          <strong style="font-size:11px">${stop.name}</strong>
          <div style="font-size:11px;color:var(--muted);margin-top:2px">`;
        arrivals.forEach(a => {
          html += `${a.bus}: <span class="eta-badge" style="font-size:10px">${typeof a.eta === 'number' ? formatDuration(a.eta) : a.eta}</span> `;
        });
        html += `</div></div>`;
      });
      board.innerHTML = html || 'Waiting for live data...';
    }

    function computeETA(busPos, stop, route){
      // Simple heuristic: haversine distance / average speed
      const d = haversine([busPos.lat, busPos.lng], [stop.lat, stop.lng]);
      const speedMs = (busPos.speed || 30) * (1000/3600); // km/h to m/s
      return d / speedMs; // seconds
    }

    function haversine(a, b){
      const R = 6371000;
      const toRad = d => d*Math.PI/180;
      const dLat = toRad(b[0]-a[0]);
      const dLng = toRad(b[1]-a[1]);
      const lat1 = toRad(a[0]);
      const lat2 = toRad(b[0]);
      const sa = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(sa));
    }

    function formatDuration(sec){
      sec = Math.max(0, Math.round(sec));
      const m = Math.floor(sec/60); const s = sec%60;
      if(m >= 60){ const h = Math.floor(m/60); const mm = m%60; return `${h}h ${mm}m`; }
      if(m >= 1) return `${m}m`;
      return `${s}s`;
    }

    function showBusOnMap(){
      if(!selectedBus || !selectedRoute) return;
      document.getElementById('selectedBusInfo').style.display = 'block';
      document.getElementById('infoBusName').textContent = selectedBus.name || selectedBus.id;
      document.getElementById('infoRoute').textContent = selectedRoute.name;
      
      const pos = busPositions[selectedBus.id];
      const speed = pos ? (pos.speed || 0) : 0;
      document.getElementById('infoSpeed').textContent = speed.toFixed ? speed.toFixed(0) : speed;
      
      const nextStop = (selectedRoute.stops && selectedRoute.stops[1]) ? selectedRoute.stops[1] : null;
      document.getElementById('infoNextStop').textContent = nextStop ? nextStop.name : '‚Äî';
      
      if(pos && nextStop){
        const eta = computeETA(pos, nextStop, selectedRoute);
        document.getElementById('infoETA').textContent = formatDuration(eta);
      } else {
        document.getElementById('infoETA').textContent = '--';
      }
    }

    // Debounced journey planning
    const planJourneyCore = () => {
      const fromName = document.getElementById('fromStop').value;
      const toName = document.getElementById('toStop').value;
      if(!fromName || !toName) return alert('Please select both stops');
      
      // Find stops across all routes
      let fromStop = null, toStop = null, bestRoute = null;
      routes.forEach(r => {
        r.stops.forEach(s => {
          if(s.name === fromName) fromStop = s;
          if(s.name === toName) toStop = s;
        });
        if(fromStop && toStop && !bestRoute) bestRoute = r;
      });
      if(!fromStop || !toStop) return alert('Stops not found');

      const dist = haversine([fromStop.lat, fromStop.lng], [toStop.lat, toStop.lng]);
      const avgSpeed = 30; // km/h
      const etaSec = (dist / 1000) / avgSpeed * 3600; // seconds
      const recBus = bestRoute && bestRoute.buses && bestRoute.buses[0] ? (bestRoute.buses[0].name || bestRoute.buses[0].id) : 'N/A';

      const result = document.getElementById('journeyResult');
      result.style.display = 'block';
      result.innerHTML = `
        <div class="card">
          <h4 style="margin:0 0 8px;font-size:13px">üìç ${fromName} ‚Üí ${toName}</h4>
          <div style="font-size:13px">
            <div style="margin:4px 0"><strong>Route:</strong> ${bestRoute ? bestRoute.name : 'N/A'}</div>
            <div style="margin:4px 0"><strong>Recommended Bus:</strong> ${recBus}</div>
            <div style="margin:4px 0"><strong>Distance:</strong> ${(dist/1000).toFixed(1)} km</div>
            <div style="margin:4px 0"><strong>ETA:</strong> <span class="eta-badge">${formatDuration(etaSec)}</span></div>
            <div style="margin:4px 0;color:var(--muted)">Based on avg speed ${avgSpeed} km/h</div>
          </div>
        </div>
      `;
    };
    
    // Debounce journey planning on select changes (300ms)
    const debouncedPlan = debounce(planJourneyCore, 300);
    document.getElementById('fromStop').addEventListener('change', debouncedPlan);
    document.getElementById('toStop').addEventListener('change', debouncedPlan);
    document.getElementById('btnPlanJourney').onclick = planJourneyCore;

    document.getElementById('btnRefresh').onclick = () => location.reload();
    document.getElementById('btnLocateMe').onclick = () => {
      if(!navigator.geolocation) return alert('Geolocation not supported');
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        document.getElementById('userLocationText').textContent = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
      });
    };

    document.getElementById('btnOpenMap').onclick = () => {
      const qs = new URLSearchParams();
      if(selectedRoute){ qs.set('route', selectedRoute.id || selectedRoute.code); }
      if(selectedBus){ qs.set('bus', selectedBus.id || selectedBus.name); }
      const url = `../tracker.html?${qs.toString()}`;
      window.open(url, '_blank');
    };
  </script>
</body>
</html>
